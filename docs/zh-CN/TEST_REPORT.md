# @dreamer/middlewares æµ‹è¯•æŠ¥å‘Š

## ğŸ“Š æµ‹è¯•æ¦‚è§ˆ

- **æµ‹è¯•åº“ç‰ˆæœ¬**ï¼š@dreamer/test@^1.0.0-beta.40
- **è¿è¡Œæ—¶é€‚é…å™¨**ï¼š@dreamer/runtime-adapter@^1.0.0-beta.22
- **æµ‹è¯•æ¡†æ¶**ï¼š@dreamer/testï¼ˆå…¼å®¹ Deno ä¸ Bunï¼‰
- **æµ‹è¯•æ—¥æœŸ**ï¼š2026-02-11
- **æµ‹è¯•ç¯å¢ƒ**ï¼š
  - Deno 2.6+
  - Bun 1.3.5

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

### æ€»ä½“ç»Ÿè®¡

- **æ€»æµ‹è¯•æ•°**ï¼š209
- **é€šè¿‡**ï¼š209 âœ…
- **å¤±è´¥**ï¼š0
- **é€šè¿‡ç‡**ï¼š100% âœ…
- **æ‰§è¡Œæ—¶é—´**ï¼šçº¦ 12 ç§’
- **æµ‹è¯•æ–‡ä»¶æ•°**ï¼š17

### æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

| #  | æµ‹è¯•æ–‡ä»¶                       | ç”¨ä¾‹æ•° | çŠ¶æ€        |
| -- | ------------------------------ | ------ | ----------- |
| 1  | `body-parser.test.ts`          | 8      | âœ… å…¨éƒ¨é€šè¿‡ |
| 2  | `compression.test.ts`          | 8      | âœ… å…¨éƒ¨é€šè¿‡ |
| 3  | `cors.test.ts`                 | 9      | âœ… å…¨éƒ¨é€šè¿‡ |
| 4  | `csrf.test.ts`                 | 16     | âœ… å…¨éƒ¨é€šè¿‡ |
| 5  | `error-handler.test.ts`        | 10     | âœ… å…¨éƒ¨é€šè¿‡ |
| 6  | `health-check.test.ts`         | 8      | âœ… å…¨éƒ¨é€šè¿‡ |
| 7  | `metrics.test.ts`              | 19     | âœ… å…¨éƒ¨é€šè¿‡ |
| 8  | `performance-analyzer.test.ts` | 14     | âœ… å…¨éƒ¨é€šè¿‡ |
| 9  | `rate-limit.test.ts`           | 7      | âœ… å…¨éƒ¨é€šè¿‡ |
| 10 | `request-id.test.ts`           | 12     | âœ… å…¨éƒ¨é€šè¿‡ |
| 11 | `request-logger.test.ts`       | 6      | âœ… å…¨éƒ¨é€šè¿‡ |
| 12 | `request-signature.test.ts`    | 18     | âœ… å…¨éƒ¨é€šè¿‡ |
| 13 | `request-validator.test.ts`    | 16     | âœ… å…¨éƒ¨é€šè¿‡ |
| 14 | `response-cache.test.ts`       | 21     | âœ… å…¨éƒ¨é€šè¿‡ |
| 15 | `security-headers.test.ts`     | 15     | âœ… å…¨éƒ¨é€šè¿‡ |
| 16 | `static-files.test.ts`         | 16     | âœ… å…¨éƒ¨é€šè¿‡ |
| 17 | `timeout.test.ts`              | 6      | âœ… å…¨éƒ¨é€šè¿‡ |

---

## ğŸ” åŠŸèƒ½æµ‹è¯•è¯¦æƒ…

### 1. Body Parser ä¸­é—´ä»¶ (body-parser.test.ts) - 8 é¡¹

- âœ… JSON è§£æã€éæ³• JSON å¤„ç†
- âœ… URL ç¼–ç è¡¨å•è§£æã€æ–‡æœ¬è¯·æ±‚ä½“è§£æ
- âœ… è‡ªå®šä¹‰ JSON/è¡¨å•/æ–‡æœ¬å¤§å°é™åˆ¶

### 2. Compression ä¸­é—´ä»¶ (compression.test.ts) - 8 é¡¹

- âœ… åˆ›å»ºå‹ç¼©ä¸­é—´ä»¶ï¼Œgzip/brotli å‹ç¼©
- âœ… å¯¹ä¸å¯å‹ç¼©å“åº”è·³è¿‡å‹ç¼©
- âœ… è‡ªå®šä¹‰å‹ç¼©çº§åˆ«ã€æ–‡ä»¶ç±»å‹è¿‡æ»¤ã€å¤§å°é˜ˆå€¼

### 3. CORS ä¸­é—´ä»¶ (cors.test.ts) - 9 é¡¹

- âœ… åˆ›å»º CORS ä¸­é—´ä»¶ã€OPTIONS é¢„æ£€ã€æ·»åŠ  CORS å¤´
- âœ… è‡ªå®šä¹‰ originã€methodsã€allowed headersã€credentialsã€maxAge

### 4. CSRF é˜²æŠ¤ä¸­é—´ä»¶ (csrf.test.ts) - 16 é¡¹

- âœ… åˆ›å»ºä¸­é—´ä»¶ã€GET ç”Ÿæˆ tokenã€è·³è¿‡å®‰å…¨æ–¹æ³•
- âœ… æ ¡éªŒ POST tokenã€header/è¡¨å•å­—æ®µ tokenã€æ‹’ç»æ— æ•ˆ token
- âœ… è‡ªå®šä¹‰ cookie/header/è¡¨å•å­—æ®µåã€token
  ç”Ÿæˆã€shouldSkip/shouldVerifyã€é”™è¯¯ä¿¡æ¯ã€cookie é€‰é¡¹

### 5. Error Handler ä¸­é—´ä»¶ (error-handler.test.ts) - 10 é¡¹

- âœ… åˆ›å»ºé”™è¯¯å¤„ç†ä¸­é—´ä»¶ã€åŒæ­¥/å¼‚æ­¥é”™è¯¯å¤„ç†
- âœ… è‡ªå®šä¹‰ formatErrorã€includeDetailsã€å¼€å‘æ¨¡å¼ã€é”™è¯¯ä¿®å¤å»ºè®®
- âœ… å¼€å‘/ç”Ÿäº§æ¨¡å¼ä¸‹ JSON å“åº”æ ¼å¼åŒ–

### 6. Health Check ä¸­é—´ä»¶ (health-check.test.ts) - 8 é¡¹

- âœ… åˆ›å»ºå¥åº·æ£€æŸ¥ä¸­é—´ä»¶ã€å“åº”å¥åº·æ£€æŸ¥ã€å¿½ç•¥éå¥åº·æ£€æŸ¥è·¯å¾„
- âœ… è‡ªå®šä¹‰è·¯å¾„ã€å“åº”ä½“ã€çŠ¶æ€ç ã€æ£€æŸ¥å‡½æ•°

### 7. Metrics ä¸­é—´ä»¶ (metrics.test.ts) - 19 é¡¹

- âœ… åˆ›å»º Metrics ä¸­é—´ä»¶ã€è¯·æ±‚ç»Ÿè®¡ã€çŠ¶æ€ç åˆ†å¸ƒ
- âœ… è‡ªå®šä¹‰è·¯å¾„ã€shouldSkipã€getMetricsStatsã€resetMetrics
- âœ… å¤šè¯·æ±‚ç´¯è®¡ã€å»¶è¿Ÿç»Ÿè®¡

### 8. Performance Analyzer ä¸­é—´ä»¶ (performance-analyzer.test.ts) - 14 é¡¹

- âœ… åˆ›å»ºæ€§èƒ½åˆ†æä¸­é—´ä»¶ã€è®°å½•è€—æ—¶ã€clearPerformanceDataã€getPerformanceStats
- âœ… è‡ªå®šä¹‰ shouldSkipã€å¤šä¸­é—´ä»¶é“¾è€—æ—¶

### 9. Rate Limit ä¸­é—´ä»¶ (rate-limit.test.ts) - 7 é¡¹

- âœ… åˆ›å»ºé™æµä¸­é—´ä»¶ã€é™åˆ¶è¯·æ±‚æ•°ã€æ—¶é—´çª—é‡ç½®ã€è‡ªå®šä¹‰ keyã€skip

### 10. Request ID ä¸­é—´ä»¶ (request-id.test.ts) - 12 é¡¹

- âœ… åˆ›å»ºä¸­é—´ä»¶ã€ç”Ÿæˆ Request IDã€å†™å…¥å“åº”å¤´ã€å­˜å…¥ ctx.state
- âœ… ä»è¯·æ±‚å¤´è¯»å–å·²æœ‰ IDã€è‡ªå®šä¹‰å¤´åã€ç¦ç”¨å“åº”å¤´ã€è‡ªå®šä¹‰ç”Ÿæˆå™¨ã€ç¦ç”¨ä»è¯·æ±‚å¤´è¯»å–
- âœ… å¤šè¯·æ±‚ä½¿ç”¨ä¸åŒ ID

### 11. Request Logger ä¸­é—´ä»¶ (request-logger.test.ts) - 6 é¡¹

- âœ… åˆ›å»ºè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ã€è®°å½•è¯·æ±‚ä¸å“åº”çŠ¶æ€ç 
- âœ… è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ã€è·³è¿‡æ—¥å¿—

### 12. Request Signature ä¸­é—´ä»¶ (request-signature.test.ts) - 18 é¡¹

- âœ… åˆ›å»ºç­¾åæ ¡éªŒä¸­é—´ä»¶ï¼Œæ‹’ç»ç¼ºå¤±ç­¾å/æ—¶é—´æˆ³/æ— æ•ˆç­¾å/è¿‡æœŸ/æœªæ¥æ—¶é—´æˆ³
- âœ… æ¥å—æœ‰æ•ˆç­¾åï¼Œè‡ªå®šä¹‰ç®—æ³•/å¤´å/è¿‡æœŸæ—¶é—´/æ—¶é—´æˆ³å®¹å·®/shouldSkip/é”™è¯¯ä¿¡æ¯
- âœ… ç­¾åç”Ÿæˆã€ä¸åŒè¯·æ±‚ä¸åŒç­¾åã€ç­¾ååŒ…å« query ä¸ body

### 13. Request Validator ä¸­é—´ä»¶ (request-validator.test.ts) - 16 é¡¹

- âœ… åˆ›å»ºæ ¡éªŒä¸­é—´ä»¶ã€æœªé…ç½®è¯·æ±‚æ”¾è¡Œ
- âœ… è¯·æ±‚ä½“å¤§å°ä¸ URL é•¿åº¦ã€æŸ¥è¯¢å‚æ•°æ•°é‡é™åˆ¶
- âœ… å¿…å¡«å­—æ®µã€å­—æ®µæ ¼å¼ã€åˆæ³•å€¼ã€è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯ã€æ ¡éªŒå‡½æ•°è¿”å›é”™è¯¯
- âœ… è‡ªå®šä¹‰/å¼‚æ­¥è‡ªå®šä¹‰æ ¡éªŒå‡½æ•°ã€shouldSkipã€è‡ªå®šä¹‰é”™è¯¯æ ¼å¼åŒ–

### 14. Response Cache ä¸­é—´ä»¶ (response-cache.test.ts) - 21 é¡¹

- âœ… åˆ›å»ºå“åº”ç¼“å­˜ä¸­é—´ä»¶ã€ç¼“å­˜ GETã€è·³è¿‡é GET/HEADã€ä»…ç¼“å­˜ 2xx
- âœ… ETag ç”Ÿæˆã€If-None-Matchã€ç¦ç”¨ ETag
- âœ… Last-Modifiedã€If-Modified-Sinceã€ç¦ç”¨ Last-Modified
- âœ… public/private/no-cache ç­–ç•¥ï¼ŒåŸºäº URL/query/è‡ªå®šä¹‰
  keyï¼ŒshouldCache/shouldSkip
- âœ… ç¼“å­˜ç»Ÿè®¡ã€æ¸…ç©ºç¼“å­˜

### 15. Security Headers ä¸­é—´ä»¶ (security-headers.test.ts) - 15 é¡¹

- âœ… åˆ›å»ºå®‰å…¨å¤´ä¸­é—´ä»¶ã€é»˜è®¤å®‰å…¨å¤´
- âœ…
  COEPã€COOPã€CORPã€X-DNS-Prefetch-Controlã€X-Download-Optionsã€X-Permitted-Cross-Domain-Policies
- âœ… åŠ¨æ€/å¼‚æ­¥åŠ¨æ€å®‰å…¨ç­–ç•¥ã€é…ç½®æ ¡éªŒã€COEP ä¸ COOP ç»„åˆå‘Šè­¦
- âœ… ç¦ç”¨é»˜è®¤å®‰å…¨å¤´ã€è‡ªå®šä¹‰å®‰å…¨å¤´å–å€¼

### 16. Static Files ä¸­é—´ä»¶ (static-files.test.ts) - 16 é¡¹

- âœ… åˆ›å»ºé™æ€æ–‡ä»¶ä¸­é—´ä»¶ã€è‡ªå®šä¹‰æ ¹ç›®å½•ä¸è·¯å¾„å‰ç¼€ã€æä¾›é™æ€æ–‡ä»¶
- âœ… è‡ªå®šä¹‰ index æ–‡ä»¶ã€ç¼“å­˜æ§åˆ¶ã€ETagã€Last-Modified
- âœ… å¯ç”¨/ç¦ç”¨å†…å­˜ç¼“å­˜ã€ç¼“å­˜æœ€å¤§å®¹é‡ä¸ TTLã€ä»ç¼“å­˜è¯»å–ã€æ–‡ä»¶å˜æ›´åç¼“å­˜æ›´æ–°

### 17. Timeout ä¸­é—´ä»¶ (timeout.test.ts) - 6 é¡¹

- âœ… åˆ›å»ºè¶…æ—¶ä¸­é—´ä»¶ã€è¶…æ—¶å†…é€šè¿‡ã€è¶…æ—¶è¿”å›
- âœ… è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯ã€skip å‡½æ•°

---

## ğŸ“Š è¦†ç›–ç‡åˆ†æ

| è¦†ç›–é¡¹           | è¯´æ˜                                                                      |
| ---------------- | ------------------------------------------------------------------------- |
| **API æ–¹æ³•è¦†ç›–** | âœ… æ‰€æœ‰å¯¼å‡ºçš„ä¸­é—´ä»¶å·¥å‚ï¼ˆå¦‚ requestIdã€corsã€bodyParserï¼‰å‡æœ‰å¯¹åº”æµ‹è¯•æ–‡ä»¶ |
| **é…ç½®é¡¹è¦†ç›–**   | âœ… å„ä¸­é—´ä»¶ä¸»è¦é…ç½®ï¼ˆå¦‚ headerNameã€skipã€limitã€shouldCacheï¼‰å‡æœ‰ç”¨ä¾‹    |
| **è¾¹ç•Œæƒ…å†µè¦†ç›–** | âœ… éæ³• JSONã€ç¼ºå¤±ç­¾åã€è¿‡æœŸæ—¶é—´æˆ³ã€è¶…æ—¶ã€å¤§è¯·æ±‚ä½“ã€æ¡ä»¶è¯·æ±‚ç­‰å‡æœ‰æµ‹è¯•    |
| **é”™è¯¯å¤„ç†è¦†ç›–** | âœ… é”™è¯¯å¤„ç†ä¸­é—´ä»¶ã€é™æµ/ç­¾å/æ ¡éªŒå¤±è´¥å“åº”ã€è¶…æ—¶å“åº”å‡å·²è¦†ç›–               |
| **è¿è¡Œæ—¶å…¼å®¹**   | âœ… ä½¿ç”¨ @dreamer/server HttpContext ä¸ CookieManagerï¼Œå…¼å®¹ Deno/Bun       |

---

## âœ… ä¼˜ç‚¹

- æ¯ä¸ªå†…ç½®ä¸­é—´ä»¶æœ‰ç‹¬ç«‹æµ‹è¯•æ–‡ä»¶ï¼Œä¸æºç ä¸€ä¸€å¯¹åº”
- æµ‹è¯•è¦†ç›–åˆ›å»ºã€é»˜è®¤è¡Œä¸ºã€é…ç½®é¡¹ã€è¾¹ç•Œæƒ…å†µä¸é”™è¯¯è·¯å¾„
- ä½¿ç”¨ç»Ÿä¸€çš„ createTestContext ä¸ @dreamer/server ç±»å‹ä¾¿äºç»´æŠ¤
- Request ID å­˜äº ctx.stateï¼Œä¸ error-handler ç­‰ä¸­é—´ä»¶ä¸€è‡´
- é™æ€æ–‡ä»¶ä¸å“åº”ç¼“å­˜ä½¿ç”¨ @dreamer/runtime-adapter å®ç°è·¨è¿è¡Œæ—¶æ”¯æŒ

---

## ğŸ“ ç»“è®º

âœ… **209 é¡¹æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œé€šè¿‡ç‡ 100%**

@dreamer/middlewares æä¾› 17 ä¸ªå†…ç½®ä¸­é—´ä»¶ï¼ŒåŠŸèƒ½ä¸é…ç½®å‡æœ‰æµ‹è¯•è¦†ç›–ã€‚å¯ä¸
@dreamer/server æˆ–ä»»æ„å…¼å®¹ HttpContext çš„æ¡†æ¶é…åˆä½¿ç”¨ã€‚

---

_æœ€åæ›´æ–°ï¼š2026-02-11_
